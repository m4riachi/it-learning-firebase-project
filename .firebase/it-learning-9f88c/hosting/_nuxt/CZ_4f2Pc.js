import{e as Z,g as ee,u as se,f as te,h as I,r as c,i as ae,q as C,j as p,k as M,l as F,m as Q,n as R,p as oe,c as l,a as t,F as h,s as j,v as re,x as V,y as $,z as ie,A as q,B as le,C as ne,D as v,E as z,o as n,G as A,t as f,H}from"./V3PcRQWG.js";const de={class:"flex h-screen bg-gray-100"},ue={key:0,class:"flex-1 flex items-center justify-center"},ce={class:"w-80 bg-white border-r border-gray-200"},me={class:"h-full flex flex-col"},pe={class:"flex-1 overflow-y-auto"},ve=["onClick"],ge={class:"flex justify-between items-start"},ye={class:"flex items-center"},fe={class:"w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center"},he={class:"text-gray-600 font-medium"},xe={class:"ml-3"},be={class:"text-sm font-medium text-gray-900"},we={class:"text-sm text-gray-500 truncate"},_e={class:"p-4 border-t border-gray-200"},Ce={class:"flex-1 flex flex-col"},Ue={class:"text-sm"},ke={class:"text-xs mt-1 opacity-70"},Ne={class:"p-4 border-t border-gray-200 bg-white"},De={key:1,class:"flex-1 flex items-center justify-center bg-gray-50"},Le={key:0,class:"fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center"},Me={class:"bg-white rounded-lg p-6 max-w-md w-full"},Re={class:"max-h-60 overflow-y-auto"},je=["onClick"],Ae={class:"mt-4 flex justify-end"},Be=Z({__name:"Chat",setup(Se){const u=ee(),U=se(),G=te(),o=I(()=>U==null?void 0:U.currentUser),k=c(!0),S=c([]),g=c(null),N=c([]),y=c(""),x=c(null),b=c(!1),w=c(""),D=c([]),J=async()=>{var a;if(o.value)try{const e=q(u,"users",o.value.uid),s=await le(e);s.exists()?await z(e,{updatedAt:v(),email:o.value.email,displayName:o.value.displayName||s.data().displayName,photoURL:o.value.photoURL||s.data().photoURL}):await ne(e,{uid:o.value.uid,email:o.value.email,displayName:o.value.displayName||((a=o.value.email)==null?void 0:a.split("@")[0])||"Unknown User",photoURL:o.value.photoURL||null,createdAt:v(),updatedAt:v()})}catch(e){console.error("Error ensuring user document:",e)}};ae(async()=>{var a;if(!((a=o.value)!=null&&a.uid)){G.push("/login");return}try{await J();const e=C(p(u,"chats"),M("participants","array-contains",o.value.uid),F("lastMessageAt","desc"));Q(e,async r=>{var d;const i=[];for(const m of r.docs){const _={id:m.id,...m.data()},B=_.participants.find(Y=>{var E;return Y!==((E=o.value)==null?void 0:E.uid)}),X=await R(C(p(u,"users"),M("uid","==",B)));_.otherUser=((d=X.docs[0])==null?void 0:d.data())||{displayName:"Unknown User",email:"",uid:B},i.push(_)}S.value=i,k.value=!1});const s=await R(p(u,"users"));D.value=s.docs.map(r=>({uid:r.data().uid,displayName:r.data().displayName||"Unknown User",email:r.data().email||"",photoURL:r.data().photoURL||null})).filter(r=>{var i;return r.uid!==((i=o.value)==null?void 0:i.uid)})}catch(e){console.error("Error initializing chat:",e),k.value=!1}});const K=I(()=>{if(!w.value)return D.value;const a=w.value.toLowerCase();return D.value.filter(e=>{var s,r;return((s=e.displayName)==null?void 0:s.toLowerCase().includes(a))||((r=e.email)==null?void 0:r.toLowerCase().includes(a))})}),L=async a=>{g.value=a;const e=C(p(u,"chats",a.id,"messages"),F("timestamp","asc"));Q(e,s=>{N.value=s.docs.map(r=>({id:r.id,...r.data()})),T()})},O=a=>a?new Date(a.seconds*1e3).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):"",P=async()=>{var a,e;if(!(!y.value.trim()||!((a=g.value)!=null&&a.id)||!((e=o.value)!=null&&e.uid)))try{await H(p(u,"chats",g.value.id,"messages"),{text:y.value.trim(),senderId:o.value.uid,timestamp:v()}),await z(q(u,"chats",g.value.id),{lastMessage:{text:y.value.trim(),senderId:o.value.uid},lastMessageAt:v()}),y.value=""}catch(s){console.error("Error sending message:",s)}},W=async a=>{var e;if((e=o.value)!=null&&e.uid)try{const s=C(p(u,"chats"),M("participants","array-contains",o.value.uid)),i=(await R(s)).docs.find(d=>d.data().participants.includes(a.uid));if(i)L({id:i.id,...i.data()});else{const d={participants:[o.value.uid,a.uid],createdAt:v(),lastMessageAt:v(),lastMessage:null},m=await H(p(u,"chats"),d);L({id:m.id,...d,otherUser:{uid:a.uid,displayName:a.displayName||"Unknown User",email:a.email||""}})}b.value=!1}catch(s){console.error("Error starting chat:",s)}},T=()=>{setTimeout(()=>{x.value&&(x.value.scrollTop=x.value.scrollHeight)},100)};return oe(N,T),(a,e)=>(n(),l("div",de,[k.value?(n(),l("div",ue,e[4]||(e[4]=[t("div",{class:"flex flex-col items-center"},[t("div",{class:"animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"}),t("p",{class:"mt-4 text-gray-600"},"Loading chat...")],-1)]))):(n(),l(h,{key:1},[t("div",ce,[t("div",me,[e[5]||(e[5]=t("div",{class:"p-4 border-b border-gray-200"},[t("h2",{class:"text-lg font-semibold text-gray-900"},"Messages")],-1)),t("div",pe,[(n(!0),l(h,null,j(S.value,s=>{var r,i,d,m;return n(),l("div",{key:s.id,onClick:_=>L(s),class:A(["p-4 hover:bg-gray-50 cursor-pointer",{"bg-indigo-50":((r=g.value)==null?void 0:r.id)===s.id}])},[t("div",ge,[t("div",ye,[t("div",fe,[t("span",he,f(((d=(i=s.otherUser.displayName)==null?void 0:i[0])==null?void 0:d.toUpperCase())||"?"),1)]),t("div",xe,[t("p",be,f(s.otherUser.displayName),1),t("p",we,f(((m=s.lastMessage)==null?void 0:m.text)||"No messages yet"),1)])])])],10,ve)}),128))]),t("div",_e,[t("button",{onClick:e[0]||(e[0]=s=>b.value=!0),class:"w-full flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700"}," New Chat ")])])]),t("div",Ce,[g.value?(n(),l(h,{key:0},[e[7]||(e[7]=t("div",{class:"p-4 border-b border-gray-200 bg-white"},[t("div",{class:"flex items-center"})],-1)),t("div",{class:"flex-1 overflow-y-auto p-4 space-y-4",ref_key:"messagesContainer",ref:x},[(n(!0),l(h,null,j(N.value,s=>{var r,i;return n(),l("div",{key:s.id,class:A(["flex",{"justify-end":s.senderId===((r=o.value)==null?void 0:r.uid)}])},[t("div",{class:A(["max-w-[70%] rounded-lg px-4 py-2",s.senderId===((i=o.value)==null?void 0:i.uid)?"bg-indigo-600 text-white":"bg-gray-100 text-gray-900"])},[t("p",Ue,f(s.text),1),t("p",ke,f(O(s.timestamp)),1)],2)],2)}),128))],512),t("div",Ne,[t("form",{onSubmit:re(P,["prevent"]),class:"flex space-x-4"},[V(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>y.value=s),type:"text",placeholder:"Type your message...",class:"flex-1 rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500"},null,512),[[$,y.value]]),e[6]||(e[6]=t("button",{type:"submit",class:"inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700"}," Send ",-1))],32)])],64)):(n(),l("div",De,e[8]||(e[8]=[t("p",{class:"text-gray-500 text-lg"},"Select a chat or start a new conversation",-1)])))]),b.value?(n(),l("div",Le,[t("div",Me,[e[9]||(e[9]=t("h3",{class:"text-lg font-medium text-gray-900 mb-4"},"Start a new chat",-1)),V(t("input",{"onUpdate:modelValue":e[2]||(e[2]=s=>w.value=s),type:"text",placeholder:"Search users...",class:"w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 mb-4"},null,512),[[$,w.value]]),t("div",Re,[(n(!0),l(h,null,j(K.value,s=>(n(),l("div",{key:s.uid,onClick:r=>W(s),class:"p-2 hover:bg-gray-50 cursor-pointer rounded-md"},f(s.displayName||s.email),9,je))),128))]),t("div",Ae,[t("button",{onClick:e[3]||(e[3]=s=>b.value=!1),class:"mr-2 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 rounded-md"}," Cancel ")])])])):ie("",!0)],64))]))}});export{Be as default};
